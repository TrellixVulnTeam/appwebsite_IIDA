{"ast":null,"code":"\"use strict\";\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n    label: 0,\n    sent: function () {\n      if (t[0] & 1) throw t[1];\n      return t[1];\n    },\n    trys: [],\n    ops: []\n  },\n      f,\n      y,\n      t,\n      g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n\n        case 7:\n          op = _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n\n            _.ops.push(op);\n\n            break;\n          }\n\n          if (t[2]) _.ops.pop();\n\n          _.trys.pop();\n\n          continue;\n      }\n\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.calculateExternalPositionUnit = exports.calculateUSDCTransferOut = exports.calculateUSDCTransferIn = exports.leverUp = exports.toUSDCDecimals = void 0;\n\nvar ethers_1 = require(\"ethers\");\n\nvar index_1 = require(\"../index\");\n\nvar constants_1 = require(\"../constants\"); // Converts PRECISE_UNIT value into USDC decimals value\n\n\nfunction toUSDCDecimals(quantity) {\n  return quantity.div(ethers_1.BigNumber.from(10).pow(12));\n}\n\nexports.toUSDCDecimals = toUSDCDecimals; // Allocates all deposited collateral to a levered position. Returns new baseToken position unit\n\nfunction leverUp(setToken, module, fixture, owner, baseToken, leverageRatio, slippagePercentage, isLong) {\n  return __awaiter(this, void 0, void 0, function () {\n    var spotPrice, totalSupply, collateralBalance, baseTradeQuantityNotional, baseTradeQuantityUnit, estimatedQuoteQuantityNotional, allowedSlippage, slippageAdjustedQuoteQuanitityNotional, receiveQuoteQuantityUnit;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          return [4\n          /*yield*/\n          , fixture.getSpotPrice(baseToken)];\n\n        case 1:\n          spotPrice = _a.sent();\n          return [4\n          /*yield*/\n          , setToken.totalSupply()];\n\n        case 2:\n          totalSupply = _a.sent();\n          return [4\n          /*yield*/\n          , module.getAccountInfo(setToken.address)];\n\n        case 3:\n          collateralBalance = _a.sent().collateralBalance;\n          baseTradeQuantityNotional = (0, index_1.preciseDiv)(collateralBalance.mul(leverageRatio), spotPrice);\n          baseTradeQuantityUnit = isLong ? (0, index_1.preciseDiv)(baseTradeQuantityNotional, totalSupply) : (0, index_1.preciseDiv)(baseTradeQuantityNotional, totalSupply).mul(-1);\n          estimatedQuoteQuantityNotional = (0, index_1.preciseMul)(baseTradeQuantityNotional, spotPrice).abs();\n          allowedSlippage = (0, index_1.preciseMul)(estimatedQuoteQuantityNotional, (0, index_1.ether)(.02));\n          slippageAdjustedQuoteQuanitityNotional = isLong ? estimatedQuoteQuantityNotional.add(allowedSlippage) : estimatedQuoteQuantityNotional.sub(allowedSlippage);\n          receiveQuoteQuantityUnit = (0, index_1.preciseDiv)(slippageAdjustedQuoteQuanitityNotional, totalSupply);\n          return [4\n          /*yield*/\n          , module.connect(owner.wallet).trade(setToken.address, baseToken, baseTradeQuantityUnit, receiveQuoteQuantityUnit)];\n\n        case 4:\n          _a.sent();\n\n          return [2\n          /*return*/\n          , baseTradeQuantityUnit];\n      }\n    });\n  });\n}\n\nexports.leverUp = leverUp; // Returns notional amount of USDC to transfer in on issue. Handles multiple positions, long and short.\n\nfunction calculateUSDCTransferIn(setToken, setQuantity, module, fixture) {\n  return __awaiter(this, void 0, void 0, function () {\n    var accountInfo, totalCollateralValue, totalSupply, usdcAmountIn, allPositionInfo, _i, allPositionInfo_1, positionInfo, baseTradeQuantityNotional, isLong, deltaQuote, idealQuote, _a, _b, expectedSlippage;\n\n    return __generator(this, function (_c) {\n      switch (_c.label) {\n        case 0:\n          return [4\n          /*yield*/\n          , module.getAccountInfo(setToken.address)];\n\n        case 1:\n          accountInfo = _c.sent();\n          totalCollateralValue = accountInfo.collateralBalance.add(accountInfo.owedRealizedPnl).add(accountInfo.pendingFundingPayments).add(accountInfo.netQuoteBalance);\n          return [4\n          /*yield*/\n          , setToken.totalSupply()];\n\n        case 2:\n          totalSupply = _c.sent();\n          usdcAmountIn = (0, index_1.preciseMul)((0, index_1.preciseDiv)(totalCollateralValue, totalSupply), setQuantity);\n          return [4\n          /*yield*/\n          , module.getPositionUnitInfo(setToken.address)];\n\n        case 3:\n          allPositionInfo = _c.sent();\n          _i = 0, allPositionInfo_1 = allPositionInfo;\n          _c.label = 4;\n\n        case 4:\n          if (!(_i < allPositionInfo_1.length)) return [3\n          /*break*/\n          , 8];\n          positionInfo = allPositionInfo_1[_i];\n          baseTradeQuantityNotional = (0, index_1.preciseMul)(positionInfo.baseUnit, setQuantity);\n          isLong = baseTradeQuantityNotional.gte(constants_1.ZERO);\n          return [4\n          /*yield*/\n          , fixture.getSwapQuote(positionInfo.baseToken, baseTradeQuantityNotional.abs(), isLong)];\n\n        case 5:\n          deltaQuote = _c.sent().deltaQuote;\n          _a = index_1.preciseMul;\n          _b = [baseTradeQuantityNotional];\n          return [4\n          /*yield*/\n          , fixture.getSpotPrice(positionInfo.baseToken)];\n\n        case 6:\n          idealQuote = _a.apply(void 0, _b.concat([_c.sent()]));\n          expectedSlippage = isLong ? deltaQuote.sub(idealQuote) : idealQuote.abs().sub(deltaQuote);\n          usdcAmountIn = usdcAmountIn.add(idealQuote).add(expectedSlippage);\n          _c.label = 7;\n\n        case 7:\n          _i++;\n          return [3\n          /*break*/\n          , 4];\n\n        case 8:\n          return [2\n          /*return*/\n          , toUSDCDecimals(usdcAmountIn)];\n      }\n    });\n  });\n}\n\nexports.calculateUSDCTransferIn = calculateUSDCTransferIn; // Returns notional amount of USDC to transfer on redeem. Handles multiple positions, long and short\n\nfunction calculateUSDCTransferOut(setToken, setQuantity, module, fixture) {\n  return __awaiter(this, void 0, void 0, function () {\n    var totalRealizedPnl, allPositionInfo, collateralBalance, collateralPositionUnit, _a, _b, collateralQuantityNotional, _i, allPositionInfo_2, positionInfo, basePositionUnit, _c, _d, baseTradeQuantityNotional, isLong, closeRatio, reducedOpenNotional, deltaQuote, realizedPnl;\n\n    return __generator(this, function (_e) {\n      switch (_e.label) {\n        case 0:\n          totalRealizedPnl = ethers_1.BigNumber.from(0);\n          return [4\n          /*yield*/\n          , module.getPositionNotionalInfo(setToken.address)];\n\n        case 1:\n          allPositionInfo = _e.sent();\n          return [4\n          /*yield*/\n          , module.getAccountInfo(setToken.address)];\n\n        case 2:\n          collateralBalance = _e.sent().collateralBalance;\n          _a = index_1.preciseDiv;\n          _b = [collateralBalance];\n          return [4\n          /*yield*/\n          , setToken.totalSupply()];\n\n        case 3:\n          collateralPositionUnit = _a.apply(void 0, _b.concat([_e.sent()]));\n          collateralQuantityNotional = (0, index_1.preciseMul)(collateralPositionUnit, setQuantity);\n          _i = 0, allPositionInfo_2 = allPositionInfo;\n          _e.label = 4;\n\n        case 4:\n          if (!(_i < allPositionInfo_2.length)) return [3\n          /*break*/\n          , 8];\n          positionInfo = allPositionInfo_2[_i];\n          _c = index_1.preciseDiv;\n          _d = [positionInfo.baseBalance];\n          return [4\n          /*yield*/\n          , setToken.totalSupply()];\n\n        case 5:\n          basePositionUnit = _c.apply(void 0, _d.concat([_e.sent()]));\n          baseTradeQuantityNotional = (0, index_1.preciseMul)(basePositionUnit, setQuantity);\n          isLong = basePositionUnit.gte(constants_1.ZERO);\n          closeRatio = (0, index_1.preciseDiv)(baseTradeQuantityNotional.abs(), positionInfo.baseBalance.abs());\n          reducedOpenNotional = (0, index_1.preciseMul)(positionInfo.quoteBalance, closeRatio);\n          return [4\n          /*yield*/\n          , fixture.getSwapQuote(positionInfo.baseToken, baseTradeQuantityNotional.abs(), !isLong)];\n\n        case 6:\n          deltaQuote = _e.sent().deltaQuote;\n          realizedPnl = isLong ? reducedOpenNotional.add(deltaQuote) : reducedOpenNotional.sub(deltaQuote);\n          totalRealizedPnl = totalRealizedPnl.add(realizedPnl);\n          _e.label = 7;\n\n        case 7:\n          _i++;\n          return [3\n          /*break*/\n          , 4];\n\n        case 8:\n          return [2\n          /*return*/\n          , toUSDCDecimals(collateralQuantityNotional.add(totalRealizedPnl).abs())];\n      }\n    });\n  });\n}\n\nexports.calculateUSDCTransferOut = calculateUSDCTransferOut;\n\nfunction calculateExternalPositionUnit(setToken, module, fixture) {\n  return __awaiter(this, void 0, void 0, function () {\n    var totalPositionValue, allPositionInfo, _i, allPositionInfo_3, positionInfo, spotPrice, _a, collateralBalance, pendingFundingPayments, owedRealizedPnl, netQuoteBalance, numerator, _b, _c, _d;\n\n    return __generator(this, function (_e) {\n      switch (_e.label) {\n        case 0:\n          totalPositionValue = ethers_1.BigNumber.from(0);\n          return [4\n          /*yield*/\n          , module.getPositionNotionalInfo(setToken.address)];\n\n        case 1:\n          allPositionInfo = _e.sent();\n          _i = 0, allPositionInfo_3 = allPositionInfo;\n          _e.label = 2;\n\n        case 2:\n          if (!(_i < allPositionInfo_3.length)) return [3\n          /*break*/\n          , 5];\n          positionInfo = allPositionInfo_3[_i];\n          return [4\n          /*yield*/\n          , fixture.getSpotPrice(positionInfo.baseToken)];\n\n        case 3:\n          spotPrice = _e.sent();\n          totalPositionValue = totalPositionValue.add((0, index_1.preciseMul)(positionInfo.baseBalance, spotPrice));\n          _e.label = 4;\n\n        case 4:\n          _i++;\n          return [3\n          /*break*/\n          , 2];\n\n        case 5:\n          return [4\n          /*yield*/\n          , module.getAccountInfo(setToken.address)];\n\n        case 6:\n          _a = _e.sent(), collateralBalance = _a.collateralBalance, pendingFundingPayments = _a.pendingFundingPayments, owedRealizedPnl = _a.owedRealizedPnl, netQuoteBalance = _a.netQuoteBalance;\n          numerator = totalPositionValue.add(collateralBalance).add(netQuoteBalance).add(pendingFundingPayments).add(owedRealizedPnl);\n          _b = toUSDCDecimals;\n          _c = index_1.preciseDiv;\n          _d = [numerator];\n          return [4\n          /*yield*/\n          , setToken.totalSupply()];\n\n        case 7:\n          return [2\n          /*return*/\n          , _b.apply(void 0, [_c.apply(void 0, _d.concat([_e.sent()]))])];\n      }\n    });\n  });\n}\n\nexports.calculateExternalPositionUnit = calculateExternalPositionUnit;","map":{"version":3,"sources":["/Users/safahi/Desktop/index-ui-master/node_modules/@setprotocol/set-protocol-v2/dist/utils/common/perpV2Utils.js"],"names":["__awaiter","thisArg","_arguments","P","generator","adopt","value","resolve","Promise","reject","fulfilled","step","next","e","rejected","result","done","then","apply","__generator","body","_","label","sent","t","trys","ops","f","y","g","verb","Symbol","iterator","n","v","op","TypeError","call","pop","length","push","Object","defineProperty","exports","calculateExternalPositionUnit","calculateUSDCTransferOut","calculateUSDCTransferIn","leverUp","toUSDCDecimals","ethers_1","require","index_1","constants_1","quantity","div","BigNumber","from","pow","setToken","module","fixture","owner","baseToken","leverageRatio","slippagePercentage","isLong","spotPrice","totalSupply","collateralBalance","baseTradeQuantityNotional","baseTradeQuantityUnit","estimatedQuoteQuantityNotional","allowedSlippage","slippageAdjustedQuoteQuanitityNotional","receiveQuoteQuantityUnit","_a","getSpotPrice","getAccountInfo","address","preciseDiv","mul","preciseMul","abs","ether","add","sub","connect","wallet","trade","setQuantity","accountInfo","totalCollateralValue","usdcAmountIn","allPositionInfo","_i","allPositionInfo_1","positionInfo","deltaQuote","idealQuote","_b","expectedSlippage","_c","owedRealizedPnl","pendingFundingPayments","netQuoteBalance","getPositionUnitInfo","baseUnit","gte","ZERO","getSwapQuote","concat","totalRealizedPnl","collateralPositionUnit","collateralQuantityNotional","allPositionInfo_2","basePositionUnit","_d","closeRatio","reducedOpenNotional","realizedPnl","_e","getPositionNotionalInfo","baseBalance","quoteBalance","totalPositionValue","allPositionInfo_3","numerator"],"mappings":"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","sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.calculateExternalPositionUnit = exports.calculateUSDCTransferOut = exports.calculateUSDCTransferIn = exports.leverUp = exports.toUSDCDecimals = void 0;\nvar ethers_1 = require(\"ethers\");\nvar index_1 = require(\"../index\");\nvar constants_1 = require(\"../constants\");\n// Converts PRECISE_UNIT value into USDC decimals value\nfunction toUSDCDecimals(quantity) {\n    return quantity.div(ethers_1.BigNumber.from(10).pow(12));\n}\nexports.toUSDCDecimals = toUSDCDecimals;\n// Allocates all deposited collateral to a levered position. Returns new baseToken position unit\nfunction leverUp(setToken, module, fixture, owner, baseToken, leverageRatio, slippagePercentage, isLong) {\n    return __awaiter(this, void 0, void 0, function () {\n        var spotPrice, totalSupply, collateralBalance, baseTradeQuantityNotional, baseTradeQuantityUnit, estimatedQuoteQuantityNotional, allowedSlippage, slippageAdjustedQuoteQuanitityNotional, receiveQuoteQuantityUnit;\n        return __generator(this, function (_a) {\n            switch (_a.label) {\n                case 0: return [4 /*yield*/, fixture.getSpotPrice(baseToken)];\n                case 1:\n                    spotPrice = _a.sent();\n                    return [4 /*yield*/, setToken.totalSupply()];\n                case 2:\n                    totalSupply = _a.sent();\n                    return [4 /*yield*/, module.getAccountInfo(setToken.address)];\n                case 3:\n                    collateralBalance = (_a.sent()).collateralBalance;\n                    baseTradeQuantityNotional = (0, index_1.preciseDiv)(collateralBalance.mul(leverageRatio), spotPrice);\n                    baseTradeQuantityUnit = (isLong)\n                        ? (0, index_1.preciseDiv)(baseTradeQuantityNotional, totalSupply)\n                        : (0, index_1.preciseDiv)(baseTradeQuantityNotional, totalSupply).mul(-1);\n                    estimatedQuoteQuantityNotional = (0, index_1.preciseMul)(baseTradeQuantityNotional, spotPrice).abs();\n                    allowedSlippage = (0, index_1.preciseMul)(estimatedQuoteQuantityNotional, (0, index_1.ether)(.02));\n                    slippageAdjustedQuoteQuanitityNotional = (isLong)\n                        ? estimatedQuoteQuantityNotional.add(allowedSlippage)\n                        : estimatedQuoteQuantityNotional.sub(allowedSlippage);\n                    receiveQuoteQuantityUnit = (0, index_1.preciseDiv)(slippageAdjustedQuoteQuanitityNotional, totalSupply);\n                    return [4 /*yield*/, module.connect(owner.wallet).trade(setToken.address, baseToken, baseTradeQuantityUnit, receiveQuoteQuantityUnit)];\n                case 4:\n                    _a.sent();\n                    return [2 /*return*/, baseTradeQuantityUnit];\n            }\n        });\n    });\n}\nexports.leverUp = leverUp;\n// Returns notional amount of USDC to transfer in on issue. Handles multiple positions, long and short.\nfunction calculateUSDCTransferIn(setToken, setQuantity, module, fixture) {\n    return __awaiter(this, void 0, void 0, function () {\n        var accountInfo, totalCollateralValue, totalSupply, usdcAmountIn, allPositionInfo, _i, allPositionInfo_1, positionInfo, baseTradeQuantityNotional, isLong, deltaQuote, idealQuote, _a, _b, expectedSlippage;\n        return __generator(this, function (_c) {\n            switch (_c.label) {\n                case 0: return [4 /*yield*/, module.getAccountInfo(setToken.address)];\n                case 1:\n                    accountInfo = _c.sent();\n                    totalCollateralValue = accountInfo.collateralBalance\n                        .add(accountInfo.owedRealizedPnl)\n                        .add(accountInfo.pendingFundingPayments)\n                        .add(accountInfo.netQuoteBalance);\n                    return [4 /*yield*/, setToken.totalSupply()];\n                case 2:\n                    totalSupply = _c.sent();\n                    usdcAmountIn = (0, index_1.preciseMul)((0, index_1.preciseDiv)(totalCollateralValue, totalSupply), setQuantity);\n                    return [4 /*yield*/, module.getPositionUnitInfo(setToken.address)];\n                case 3:\n                    allPositionInfo = _c.sent();\n                    _i = 0, allPositionInfo_1 = allPositionInfo;\n                    _c.label = 4;\n                case 4:\n                    if (!(_i < allPositionInfo_1.length)) return [3 /*break*/, 8];\n                    positionInfo = allPositionInfo_1[_i];\n                    baseTradeQuantityNotional = (0, index_1.preciseMul)(positionInfo.baseUnit, setQuantity);\n                    isLong = (baseTradeQuantityNotional.gte(constants_1.ZERO));\n                    return [4 /*yield*/, fixture.getSwapQuote(positionInfo.baseToken, baseTradeQuantityNotional.abs(), isLong)];\n                case 5:\n                    deltaQuote = (_c.sent()).deltaQuote;\n                    _a = index_1.preciseMul;\n                    _b = [baseTradeQuantityNotional];\n                    return [4 /*yield*/, fixture.getSpotPrice(positionInfo.baseToken)];\n                case 6:\n                    idealQuote = _a.apply(void 0, _b.concat([_c.sent()]));\n                    expectedSlippage = isLong\n                        ? deltaQuote.sub(idealQuote)\n                        : idealQuote.abs().sub(deltaQuote);\n                    usdcAmountIn = usdcAmountIn.add(idealQuote).add(expectedSlippage);\n                    _c.label = 7;\n                case 7:\n                    _i++;\n                    return [3 /*break*/, 4];\n                case 8: return [2 /*return*/, toUSDCDecimals(usdcAmountIn)];\n            }\n        });\n    });\n}\nexports.calculateUSDCTransferIn = calculateUSDCTransferIn;\n// Returns notional amount of USDC to transfer on redeem. Handles multiple positions, long and short\nfunction calculateUSDCTransferOut(setToken, setQuantity, module, fixture) {\n    return __awaiter(this, void 0, void 0, function () {\n        var totalRealizedPnl, allPositionInfo, collateralBalance, collateralPositionUnit, _a, _b, collateralQuantityNotional, _i, allPositionInfo_2, positionInfo, basePositionUnit, _c, _d, baseTradeQuantityNotional, isLong, closeRatio, reducedOpenNotional, deltaQuote, realizedPnl;\n        return __generator(this, function (_e) {\n            switch (_e.label) {\n                case 0:\n                    totalRealizedPnl = ethers_1.BigNumber.from(0);\n                    return [4 /*yield*/, module.getPositionNotionalInfo(setToken.address)];\n                case 1:\n                    allPositionInfo = _e.sent();\n                    return [4 /*yield*/, module.getAccountInfo(setToken.address)];\n                case 2:\n                    collateralBalance = (_e.sent()).collateralBalance;\n                    _a = index_1.preciseDiv;\n                    _b = [collateralBalance];\n                    return [4 /*yield*/, setToken.totalSupply()];\n                case 3:\n                    collateralPositionUnit = _a.apply(void 0, _b.concat([_e.sent()]));\n                    collateralQuantityNotional = (0, index_1.preciseMul)(collateralPositionUnit, setQuantity);\n                    _i = 0, allPositionInfo_2 = allPositionInfo;\n                    _e.label = 4;\n                case 4:\n                    if (!(_i < allPositionInfo_2.length)) return [3 /*break*/, 8];\n                    positionInfo = allPositionInfo_2[_i];\n                    _c = index_1.preciseDiv;\n                    _d = [positionInfo.baseBalance];\n                    return [4 /*yield*/, setToken.totalSupply()];\n                case 5:\n                    basePositionUnit = _c.apply(void 0, _d.concat([_e.sent()]));\n                    baseTradeQuantityNotional = (0, index_1.preciseMul)(basePositionUnit, setQuantity);\n                    isLong = (basePositionUnit.gte(constants_1.ZERO));\n                    closeRatio = (0, index_1.preciseDiv)(baseTradeQuantityNotional.abs(), positionInfo.baseBalance.abs());\n                    reducedOpenNotional = (0, index_1.preciseMul)(positionInfo.quoteBalance, closeRatio);\n                    return [4 /*yield*/, fixture.getSwapQuote(positionInfo.baseToken, baseTradeQuantityNotional.abs(), !isLong)];\n                case 6:\n                    deltaQuote = (_e.sent()).deltaQuote;\n                    realizedPnl = (isLong)\n                        ? reducedOpenNotional.add(deltaQuote)\n                        : reducedOpenNotional.sub(deltaQuote);\n                    totalRealizedPnl = totalRealizedPnl.add(realizedPnl);\n                    _e.label = 7;\n                case 7:\n                    _i++;\n                    return [3 /*break*/, 4];\n                case 8: return [2 /*return*/, toUSDCDecimals(collateralQuantityNotional.add(totalRealizedPnl).abs())];\n            }\n        });\n    });\n}\nexports.calculateUSDCTransferOut = calculateUSDCTransferOut;\nfunction calculateExternalPositionUnit(setToken, module, fixture) {\n    return __awaiter(this, void 0, void 0, function () {\n        var totalPositionValue, allPositionInfo, _i, allPositionInfo_3, positionInfo, spotPrice, _a, collateralBalance, pendingFundingPayments, owedRealizedPnl, netQuoteBalance, numerator, _b, _c, _d;\n        return __generator(this, function (_e) {\n            switch (_e.label) {\n                case 0:\n                    totalPositionValue = ethers_1.BigNumber.from(0);\n                    return [4 /*yield*/, module.getPositionNotionalInfo(setToken.address)];\n                case 1:\n                    allPositionInfo = _e.sent();\n                    _i = 0, allPositionInfo_3 = allPositionInfo;\n                    _e.label = 2;\n                case 2:\n                    if (!(_i < allPositionInfo_3.length)) return [3 /*break*/, 5];\n                    positionInfo = allPositionInfo_3[_i];\n                    return [4 /*yield*/, fixture.getSpotPrice(positionInfo.baseToken)];\n                case 3:\n                    spotPrice = _e.sent();\n                    totalPositionValue = totalPositionValue.add((0, index_1.preciseMul)(positionInfo.baseBalance, spotPrice));\n                    _e.label = 4;\n                case 4:\n                    _i++;\n                    return [3 /*break*/, 2];\n                case 5: return [4 /*yield*/, module.getAccountInfo(setToken.address)];\n                case 6:\n                    _a = _e.sent(), collateralBalance = _a.collateralBalance, pendingFundingPayments = _a.pendingFundingPayments, owedRealizedPnl = _a.owedRealizedPnl, netQuoteBalance = _a.netQuoteBalance;\n                    numerator = totalPositionValue\n                        .add(collateralBalance)\n                        .add(netQuoteBalance)\n                        .add(pendingFundingPayments)\n                        .add(owedRealizedPnl);\n                    _b = toUSDCDecimals;\n                    _c = index_1.preciseDiv;\n                    _d = [numerator];\n                    return [4 /*yield*/, setToken.totalSupply()];\n                case 7: return [2 /*return*/, _b.apply(void 0, [_c.apply(void 0, _d.concat([_e.sent()]))])];\n            }\n        });\n    });\n}\nexports.calculateExternalPositionUnit = calculateExternalPositionUnit;\n"]},"metadata":{},"sourceType":"script"}