'use strict';var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value);});}return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator['throw'](value));}catch(e){reject(e);}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());});};var __generator=this&&this.__generator||function(thisArg,body){var _={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1];},trys:[],ops:[]},f,y,t,g;return g={next:verb(0),'throw':verb(1),'return':verb(2)},typeof Symbol==='function'&&(g[Symbol.iterator]=function(){return this;}),g;function verb(n){return function(v){return step([n,v]);};}function step(op){if(f)throw new TypeError('Generator is already executing.');while(_)try{if(f=1,y&&(t=op[0]&2?y['return']:op[0]?y['throw']||((t=y['return'])&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;if(y=0,t)op=[op[0]&2,t.value];switch(op[0]){case 0:case 1:t=op;break;case 4:_.label++;return{value:op[1],done:false};case 5:_.label++;y=op[1];op=[0];continue;case 7:op=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(op[0]===6||op[0]===2)){_=0;continue;}if(op[0]===3&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break;}if(op[0]===6&&_.label<t[1]){_.label=t[1];t=op;break;}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(op);break;}if(t[2])_.ops.pop();_.trys.pop();continue;}op=body.call(thisArg,_);}catch(e){op=[6,e];y=0;}finally{f=t=0;}if(op[0]&5)throw op[1];return{value:op[0]?op[1]:void 0,done:true};}};var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{'default':mod};};Object.defineProperty(exports,'__esModule',{value:true});exports.TradeQuoter=exports.ZERO_EX_ADAPTER_NAME=void 0;var js_big_decimal_1=__importDefault(require('js-big-decimal'));var ethers_1=require('ethers');var coingecko_1=require('./coingecko');var gasOracle_1=require('./gasOracle');var zeroex_1=require('./zeroex');exports.ZERO_EX_ADAPTER_NAME='ZeroExApiAdapterV4';var SCALE=ethers_1.BigNumber.from(10).pow(18);var TradeQuoter=function(){function TradeQuoter(zeroExApiKey){if(zeroExApiKey===void 0){zeroExApiKey='';}this.tradeQuoteGasBuffer=5;this.feeRecipient='0xD3D555Bb655AcBA9452bfC6D7cEa8cC7b3628C55';this.feePercentage=0;this.isFirmQuote=true;this.slippagePercentage=2;this.excludedSources=['Kyber','Eth2Dai','Mesh'];this.zeroExApiKey=zeroExApiKey;}TradeQuoter.prototype.generate=function(options){return __awaiter(this,void 0,void 0,function(){var chainId,feePercentage,isFirmQuote,slippagePercentage,feeRecipient,excludedSources,exchangeAdapterName,_a,fromTokenAddress,toTokenAddress,fromAddress,amount,setOnChainDetails,fromTokenRequestAmount,_b,fromTokenAmount,fromUnits,toTokenAmount,toUnits,calldata,gas,coinGecko,coinPrices,gasOracle,_c;return __generator(this,function(_d){switch(_d.label){case 0:chainId=options.chainId;feePercentage=options.feePercentage||this.feePercentage;isFirmQuote=options.isFirmQuote===false?false:this.isFirmQuote;slippagePercentage=options.slippagePercentage||this.slippagePercentage;feeRecipient=options.feeRecipient||this.feeRecipient;excludedSources=options.excludedSources||this.excludedSources;exchangeAdapterName=exports.ZERO_EX_ADAPTER_NAME;_a=this.sanitizeAddress(options.fromToken,options.toToken,options.fromAddress),fromTokenAddress=_a.fromTokenAddress,toTokenAddress=_a.toTokenAddress,fromAddress=_a.fromAddress;amount=this.sanitizeAmount(options.rawAmount,options.fromTokenDecimals);return[4,options.setToken.fetchSetDetailsAsync(fromAddress,[fromTokenAddress,toTokenAddress])];case 1:setOnChainDetails=_d.sent();fromTokenRequestAmount=this.calculateFromTokenAmount(setOnChainDetails,fromTokenAddress,amount);return[4,this.fetchZeroExQuote(fromTokenAddress,toTokenAddress,fromTokenRequestAmount,setOnChainDetails.manager,setOnChainDetails.totalSupply,chainId,isFirmQuote,slippagePercentage,feeRecipient,excludedSources,feePercentage)];case 2:_b=_d.sent(),fromTokenAmount=_b.fromTokenAmount,fromUnits=_b.fromUnits,toTokenAmount=_b.toTokenAmount,toUnits=_b.toUnits,calldata=_b.calldata;this.validateQuoteValues(setOnChainDetails,fromTokenAddress,toTokenAddress,fromUnits,toUnits);return[4,this.estimateGasCost(options.tradeModule,fromTokenAddress,fromUnits,toTokenAddress,toUnits,exchangeAdapterName,fromAddress,calldata,setOnChainDetails.manager)];case 3:gas=_d.sent();coinGecko=new coingecko_1.CoinGeckoDataService(chainId);return[4,coinGecko.fetchCoinPrices({contractAddresses:[this.chainCurrencyAddress(chainId),fromTokenAddress,toTokenAddress],vsCurrencies:[coingecko_1.USD_CURRENCY_CODE,coingecko_1.USD_CURRENCY_CODE,coingecko_1.USD_CURRENCY_CODE]})];case 4:coinPrices=_d.sent();if(!!options.gasPrice)return[3,6];gasOracle=new gasOracle_1.GasOracleService(chainId);_c=options;return[4,gasOracle.fetchGasPrice()];case 5:_c.gasPrice=_d.sent();_d.label=6;case 6:return[2,{from:fromAddress,fromTokenAddress:fromTokenAddress,toTokenAddress:toTokenAddress,exchangeAdapterName:exchangeAdapterName,calldata:calldata,gas:gas.toString(),gasPrice:options.gasPrice.toString(),slippagePercentage:this.formatAsPercentage(slippagePercentage),fromTokenAmount:fromUnits.toString(),toTokenAmount:toUnits.toString(),display:{inputAmountRaw:options.rawAmount.toString(),inputAmount:amount.toString(),quoteAmount:fromTokenRequestAmount.toString(),fromTokenDisplayAmount:this.tokenDisplayAmount(fromTokenAmount,options.fromTokenDecimals),toTokenDisplayAmount:this.tokenDisplayAmount(toTokenAmount,options.toTokenDecimals),fromTokenPriceUsd:this.tokenPriceUsd(fromTokenAmount,fromTokenAddress,options.fromTokenDecimals,coinPrices),toTokenPriceUsd:this.tokenPriceUsd(toTokenAmount,toTokenAddress,options.toTokenDecimals,coinPrices),gasCostsUsd:this.gasCostsUsd(options.gasPrice,gas,coinPrices,chainId),gasCostsChainCurrency:this.gasCostsChainCurrency(options.gasPrice,gas,chainId),feePercentage:this.formatAsPercentage(feePercentage),slippage:this.calculateSlippage(fromTokenAmount,toTokenAmount,fromTokenAddress,toTokenAddress,options.fromTokenDecimals,options.toTokenDecimals,coinPrices)}}];}});});};TradeQuoter.prototype.sanitizeAddress=function(fromToken,toToken,fromAddress){return{fromTokenAddress:fromToken.toLowerCase(),toTokenAddress:toToken.toLowerCase(),fromAddress:fromAddress.toLowerCase()};};TradeQuoter.prototype.sanitizeAmount=function(rawAmount,decimals){return ethers_1.utils.parseUnits(rawAmount,decimals);};TradeQuoter.prototype.fetchZeroExQuote=function(fromTokenAddress,toTokenAddress,fromTokenRequestAmount,manager,setTotalSupply,chainId,isFirmQuote,slippagePercentage,feeRecipient,excludedSources,feePercentage){return __awaiter(this,void 0,void 0,function(){var zeroEx,quote,fromTokenAmount,fromTokenAmountBD,scaleBD,setTotalSupplyBD,fromUnitsBD,fromUnits,toTokenAmount,percentMultiplier,slippageAndFee,slippageToleranceBN,toTokenAmountMinusSlippage,toUnits;return __generator(this,function(_a){switch(_a.label){case 0:zeroEx=new zeroex_1.ZeroExTradeQuoter({chainId:chainId,zeroExApiKey:this.zeroExApiKey});return[4,zeroEx.fetchTradeQuote(fromTokenAddress,toTokenAddress,fromTokenRequestAmount,manager,isFirmQuote,slippagePercentage/100,feeRecipient,excludedSources,feePercentage/100)];case 1:quote=_a.sent();fromTokenAmount=quote.sellAmount;fromTokenAmountBD=new js_big_decimal_1.default(fromTokenAmount.toString());scaleBD=new js_big_decimal_1.default(SCALE.toString());setTotalSupplyBD=new js_big_decimal_1.default(setTotalSupply.toString());fromUnitsBD=fromTokenAmountBD.multiply(scaleBD).divide(setTotalSupplyBD,10).ceil();fromUnits=ethers_1.BigNumber.from(fromUnitsBD.getValue());toTokenAmount=quote.buyAmount;percentMultiplier=1000;slippageAndFee=slippagePercentage+feePercentage;slippageToleranceBN=Math.floor(percentMultiplier*this.outputSlippageTolerance(slippageAndFee));toTokenAmountMinusSlippage=toTokenAmount.mul(slippageToleranceBN).div(percentMultiplier);toUnits=toTokenAmountMinusSlippage.mul(SCALE).div(setTotalSupply);return[2,{fromTokenAmount:fromTokenAmount,fromUnits:fromUnits,toTokenAmount:toTokenAmount,toUnits:toUnits,calldata:quote.calldata}];}});});};TradeQuoter.prototype.validateQuoteValues=function(setOnChainDetails,fromTokenAddress,toTokenAddress,quoteFromRemainingUnits,quoteToUnits){var positionForFromToken=setOnChainDetails.positions.find(function(p){return p.component.toLowerCase()===fromTokenAddress.toLowerCase();});var currentPositionUnits=ethers_1.BigNumber.from(positionForFromToken.unit);var remainingPositionUnits=currentPositionUnits.sub(quoteFromRemainingUnits);var remainingPositionUnitsTooSmall=remainingPositionUnits.gt(0)&&remainingPositionUnits.lt(50);if(remainingPositionUnitsTooSmall){throw new Error('Remaining units too small, incorrectly attempting max');}var positionForToToken=setOnChainDetails.positions.find(function(p){return p.component.toLowerCase()===toTokenAddress.toLowerCase();});var newToPositionUnits=positionForToToken!==undefined?positionForToToken.unit.add(quoteToUnits):quoteToUnits;var newToUnitsTooSmall=newToPositionUnits.gt(0)&&newToPositionUnits.lt(50);if(newToUnitsTooSmall){throw new Error('Receive units too small');}};TradeQuoter.prototype.calculateFromTokenAmount=function(setOnChainDetails,fromTokenAddress,amount){var positionForFromToken=setOnChainDetails.positions.find(function(p){return p.component.toLowerCase()===fromTokenAddress.toLowerCase();});if(positionForFromToken===undefined){throw new Error('Invalid fromToken input');}var totalSupply=setOnChainDetails.totalSupply;var impliedMaxNotional=positionForFromToken.unit.mul(totalSupply).div(SCALE);var isGreaterThanMax=amount.gt(impliedMaxNotional);var isMax=amount.eq(impliedMaxNotional);if(isGreaterThanMax){throw new Error('Amount is greater than quantity of component in Set');}else if(isMax){return impliedMaxNotional.toString();}else{var amountMulScaleOverTotalSupply=amount.mul(SCALE).div(totalSupply);return amountMulScaleOverTotalSupply.mul(totalSupply).div(SCALE);}};TradeQuoter.prototype.tokenDisplayAmount=function(amount,decimals){return this.normalizeTokenAmount(amount,decimals).toString();};TradeQuoter.prototype.chainCurrencyAddress=function(chainId){switch(chainId){case 1:return'0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2';case 137:return'0x0d500b1d8e8ef31e21c99d1db9a6444d3adf1270';default:throw new Error('chainId: '+chainId+' is not supported');}};TradeQuoter.prototype.normalizeTokenAmount=function(amount,decimals){var tokenScale=ethers_1.BigNumber.from(10).pow(decimals);return ethers_1.FixedNumber.from(amount).divUnsafe(ethers_1.FixedNumber.from(tokenScale)).toUnsafeFloat();};TradeQuoter.prototype.tokenPriceUsd=function(amount,address,decimals,coinPrices){var coinPrice=coinPrices[address][coingecko_1.USD_CURRENCY_CODE];var normalizedAmount=this.normalizeTokenAmount(amount,decimals)*coinPrice;return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(normalizedAmount);};TradeQuoter.prototype.formatAsPercentage=function(percentage){return percentage.toFixed(2)+'%';};TradeQuoter.prototype.totalGasCost=function(gasPrice,gas){return gasPrice/1000000000*gas;};TradeQuoter.prototype.gasCostsUsd=function(gasPrice,gas,coinPrices,chainId){var totalGasCost=this.totalGasCost(gasPrice,gas);var chainCurrencyAddress=this.chainCurrencyAddress(chainId);var coinPrice=coinPrices[chainCurrencyAddress][coingecko_1.USD_CURRENCY_CODE];var cost=totalGasCost*coinPrice;var options={style:'currency',currency:'USD',maximumSignificantDigits:chainId===137?4:undefined};return new Intl.NumberFormat('en-US',options).format(cost);};TradeQuoter.prototype.gasCostsChainCurrency=function(gasPrice,gas,chainId){var chainCurrency=this.chainCurrency(chainId);var totalGasCostText=this.totalGasCost(gasPrice,gas).toFixed(7).toString();return totalGasCostText+' '+chainCurrency;};TradeQuoter.prototype.chainCurrency=function(chainId){switch(chainId){case 1:return'ETH';case 137:return'MATIC';default:return'';}};TradeQuoter.prototype.estimateGasCost=function(tradeModule,fromTokenAddress,fromTokenUnits,toTokenAddress,toTokenUnits,adapterName,fromAddress,calldata,managerAddress){return __awaiter(this,void 0,void 0,function(){var gas,gasCostBuffer,error_1;return __generator(this,function(_a){switch(_a.label){case 0:_a.trys.push([0,2,,3]);return[4,tradeModule.estimateGasForTradeAsync(fromAddress,adapterName,fromTokenAddress,fromTokenUnits,toTokenAddress,toTokenUnits,calldata,managerAddress)];case 1:gas=_a.sent();gasCostBuffer=(100+this.tradeQuoteGasBuffer)/100;return[2,Math.floor(gas.toNumber()*gasCostBuffer)];case 2:error_1=_a.sent();throw new Error('Unable to fetch gas cost estimate for trade'+error_1);case 3:return[2];}});});};TradeQuoter.prototype.calculateSlippage=function(fromTokenAmount,toTokenAmount,fromTokenAddress,toTokenAddress,fromTokenDecimals,toTokenDecimals,coinPrices){var fromTokenPriceUsd=coinPrices[fromTokenAddress][coingecko_1.USD_CURRENCY_CODE];var toTokenPriceUsd=coinPrices[toTokenAddress][coingecko_1.USD_CURRENCY_CODE];var fromTokenTotalUsd=this.normalizeTokenAmount(fromTokenAmount,fromTokenDecimals)*fromTokenPriceUsd;var toTokenTotalUsd=this.normalizeTokenAmount(toTokenAmount,toTokenDecimals)*toTokenPriceUsd;var slippageRaw=(fromTokenTotalUsd-toTokenTotalUsd)/fromTokenTotalUsd;return this.formatAsPercentage(slippageRaw*100);};TradeQuoter.prototype.outputSlippageTolerance=function(slippagePercentage){return(100-slippagePercentage)/100;};return TradeQuoter;}();exports.TradeQuoter=TradeQuoter;